<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Unicorn TRIP</title>
    <link rel="shortcut icon" href="/public/images/horn.ico" type="image/x-icon">
    <link rel="stylesheet" href="/stylesheets/index.css">
</head>
<body>
<script>
    let cities = [];
</script>
<header>Unicorn</header>
<form action="/process" method="post" id="startTHIS">
    <label>

        <input type="number" name="price" required step="0.01" value="1000" placeholder="Price" min="5"></label>
    <label>
        <select name="cityFrom" id="" required>
            <option value="" selected="selected" disabled>Origin</option>
            {{#each cities}}
                <option value="{{this.id}}">{{this.name}}</option>
                <script> cities.push({id:parseInt('{{this.id}}'), name: '{{this.name}}'})</script>
            {{/each}}
        </select>
    </label>
    <label>
        <select name="cityTo" id="" required>
            <option value="" selected="selected" disabled>Destination</option>

            {{#each cities}}
                <option value="{{this.id}}">{{this.name}}</option>
            {{/each}}
        </select>
    </label>
    <label>
        <input type="number" name="days" required min="1" value="3" placeholder="Days"></label>

    </label>
    <label>
        <div id="attr">
            <details>
                <summary>Attractions</summary>
                {{#each categories}}
                    <label><input type="checkbox" value="{{this.id}}">{{this.name}}</label>
                {{/each}}

            </details>
        </div>
        <!--<p>Attraction</p>-->

        <!--<select name="attr" id="" required>-->
            <!--{{#each categories}}-->
                <!--<option value="{{this.id}}">{{this.name}}</option>-->
            <!--{{/each}}-->
        <!--</select>-->
    </label>
    <label for="">
        <p>Date</p>
        <input type="date" name="date" required>
    </label>
    <input type="submit">
</form>
<!--<div class="results">-->
    <!--<div class="results-tickets result-item">-->
        <!--<div class="switch switch-left"></div>-->
        <!--<div class="result-content"></div>-->
        <!--<div class="switch switch-right"></div>-->
    <!--</div>-->
    <!--<div class="results-hotels result-item">-->

    <!--</div>-->
    <!--<div class="results-attrs result-item">-->

    <!--</div>-->
<!--</div>-->

<div class="results">
    <div class="results-tickets result-item results-ticket-to">
        <!--<div class="result-slide">-->

        <!--<div class="switch switch-left"></div>-->
        <!--<div class="result-content">-->
            <!--<div class="image-cont"><div class="image"></div><div class="price">120$</div></div>-->
            <!--<div class="info-cont">-->
                <!--<div class="part item">-->
                    <!--<div class="city">City 1</div>-->
                <!--</div>-->
                <!--<DIV class="middle item">-->
                    <!--<div class="line"></div><div class="date">17.09.2017 17:00</div>-->
                <!--</DIV>-->
                <!--<div class="part item">-->
                    <!--<div class="city">City 2</div>-->
                <!--</div>-->

            <!--</div>-->
        <!--</div>-->
        <!--<div class="switch switch-right"></div>-->
        <!--</div>-->
    </div>
    <div class="results-tickets result-item results-ticket-back">
        <!--<div class="switch switch-left" ></div>-->
        <!--<div class="result-content">-->
            <!--<div class="image-cont"><div class="image"></div><div class="price">120$</div></div>-->
            <!--<div class="info-cont">-->
                <!--<div class="part item">-->
                    <!--<div class="city">City 1</div>-->
                <!--</div>-->
                <!--<DIV class="middle item">-->
                    <!--<div class="line"></div><div class="date">17.09.2017 17:00</div>-->
                <!--</DIV>-->
                <!--<div class="part item">-->
                    <!--<div class="city">City 2</div>-->
                <!--</div>-->

            <!--</div>-->
        <!--</div>-->
        <!--<div class="switch switch-right" data-dir="1"></div>-->
    </div>
    <div class="results-hotels result-item">
        <!--<div class="switch switch-left"></div>-->
        <!--<div class="result-content">-->
            <!--<div class="image-cont"><div class="image"></div><div class="price">120$</div></div>-->
            <!--<div class="info-cont">-->
                <!--<span class="name">dwddwd</span>-->
                <!--<span class="mark">5</span>-->
                <!--<span class="address">dewdf ewdf ef ewf</span>-->

            <!--</div>-->
        <!--</div>-->
        <!--<div class="switch switch-right"></div>-->
    </div>
    <div class="results-attrs">
        <div class="result-content">
            <form action="" id="attrForm">
            </form>
        </div>
    </div>
    <div id="total-price"></div>
    <input type="submit" form="attrForm">
</div>
<script src="javascripts/jquery-3.2.1.min.js"></script>
<script>
$(function () {

    $('form#attrForm').submit(function (e) {
        e.preventDefault();
        $('div#total-price').text(calcPrice() + '$');

//        let attrs = $('form#attrForm input:checked').map(function (e) {
//            return $(this).attr('value');
//        });
//        console.log(attrs[0]);
//        calcPrice();
    });

    let days = 1;
    $('form#startTHIS').submit(function (e) {
        e.preventDefault();
        let from = document.getElementById('startTHIS');
        let price = from.price.value;
        let cityFrom = from.cityFrom.value ;
        let cityTo = from.cityTo.value ;
        days = from.days.value ;
        let name_city_from = from.cityFrom.options[from.cityFrom.selectedIndex ].text;
        let name_city_to = from.cityTo.options[from.cityTo.selectedIndex ].text;

//        let attr = from.attr.value ;
        let attr = [];
        $('form#startTHIS div#attr input:checked').each(function() {
            attr.push($(this).attr('value'));
        });
//        attr = attr.join(',');
//        alert(attr);
        let date = from.date.value ;
//        console.log(price, cityFrom, cityTo, days, attr, date);
        $.ajax({
            url: "/process",
            method: "POST",
            cache: false,
            data: {
                price, cityFrom,cityTo,days,attr: attr.join(','),date
            },
            success: function (data) {
                console.log(data);
//                if(data.indexOf('%TICKET-ERROR%') > -1 || data.indexOf('%%NO-TICKETS-TO%%') > -1 || data.indexOf('%TICKET-ERROR%') > -1 || data.indexOf('%NO-TICKETS-BACK%') > -1 ) {
                if(data.indexOf('%') > -1 ) {
                    console.log('no');
                    $('div.results').css('display', 'none');

                    return;
                }
                let obj = JSON.parse(data);
                console.log(obj);
                if(obj.attractions.length > 0){
                    //TODO сделать вывод результата
                    $('div.results').css('display', 'flex');
                    let str = '';
                    for(let i=0; i< obj.tickets_to.length; i++){
                        let thisDate = obj.tickets_to[i].datetime;
                        thisDate = thisDate.replace('T', ' ').substr(0, thisDate.indexOf('.'));
                        str+=`         <div class="result-slide" data-num=${i}>
                            <div class="switch switch-left" data-dir="-1"></div>
                                    <div class="result-content">
                                        <div class="image-cont"><div class="image"></div><div class="price" id="tickets_to_price" data-price=${obj.tickets_to[i].price}>${obj.tickets_to[i].price}$</div></div>
                                        <div class="info-cont">
                                            <div class="part item">
                                                <div class="city">${name_city_from}</div>
                                            </div>
                                            <DIV class="middle item">
                                                <div class="line"></div><div class="date">${thisDate}</div>
                                            </DIV>
                                            <div class="part item">
                                                <div class="city">${name_city_to}</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="switch switch-right" data-dir="1"></div></div>`;

                    }
                    $('div.results-ticket-to').append(str);
                    str = '';

                    for(let i=0; i< obj.tickets_back.length; i++){
                        let thisDate = obj.tickets_back[i].datetime;
                        thisDate = thisDate.replace('T', ' ').substr(0, thisDate.indexOf('.'));
                        str+=`         <div class="result-slide" data-num=${i}>
                            <div class="switch switch-left" data-dir="-1"></div>
                                    <div class="result-content">
                                        <div class="image-cont"><div class="image"></div><div class="price" id="tickets_from_price" data-price=${obj.tickets_back[i].price}>${obj.tickets_back[i].price}$</div></div>
                                        <div class="info-cont">
                                            <div class="part item">
                                                <div class="city">${name_city_to}</div>
                                            </div>
                                            <DIV class="middle item">
                                                <div class="line"></div><div class="date">${thisDate}</div>
                                            </DIV>
                                            <div class="part item">
                                                <div class="city">${name_city_from}</div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="switch switch-right" data-dir="1"></div></div>`;

                    }
                    $('div.results-ticket-back').append(str);
                    str = '';
                    for(let i=0; i< obj.rooms.length; i++){
//                        let thisDate = obj.tickets_back[i].datetime;
//                        thisDate = thisDate.replace('T', ' ').substr(0, thisDate.indexOf('.'));
                        str+=`         <div class="result-slide" data-num=${i}>
                                                        <div class="switch switch-left"></div>
                            <div class="result-content">
                                <div class="image-cont"><div class="image"></div><div class="price" id="hostel_price" data-price=${obj.rooms[i].price}>${obj.rooms[i].price}$</div></div>
                                <div class="info-cont">
                                    <span class="name">${obj.rooms[i].name}</span>
                                    <span class="mark">оценка посетителей ${obj.rooms[i].marks}</span>
                                    <span class="address">${obj.rooms[i].address}</span>

                                </div>
                            </div>
                            <div class="switch switch-right"></div></div>`;

                    }
                    $('div.results-hotels').append(str);
                    str = '';
                    for(let i=0; i< obj.attractions.length; i++){
                        str+=`
                    <input type="checkbox" class="attr-item" id="attr${i}" value=${obj.attractions[i].id} data-price=${obj.attractions[i].price}>
                <label for="attr${i}">${obj.attractions[i].name}</label>`;

                    }
                    $('form#attrForm').append(str);

                    $('div#total-price').text(calcPrice() + '$');

                    $('div.switch').click(function (e) {
                        // hide this block
//                        $(this).parent().parent().children().css('display', 'none');
                        let mar = $(this).parent().parent().children().eq(0).css('margin-left');
                        alert(mar);
                        $(this).parent().parent().children().eq(0).animate({marginLeft: 'calc( ' + mar +' - 50% )'}, 250);
//                        $(this).parent().parent().children().eq(0).css('margin-left', 'calc( ' + mar +' - 50% )');
                        console.log($(this).parent().parent().children().eq(0));

                        // and show all
//                        $(this).parent().css('display', 'flex');


                        $('div#total-price').text(calcPrice() + '$');

//                        let dir = parseInt($(this).attr('data-dir'));
//                        let mar = $(this).parent().css('margin-left');
////                        let mar = $(this).parent().parent().children().first().css('margin-left');
////                        let el = document.querySelector('div.')
////                        let mar = $('div.result-slide')[0].css('margin-left');
//                        alert(mar);
//                        if(dir>0){
//                            console.log($(this).parent());
//                            console.log($(this).parent().parent().children().first());
////                            $(this).parent().parent().children().first().animate({'margin-left': 'calc( ' + mar +' - 100% )'}, 250);
//                            $(this).parent().animate({'margin-left': 'calc( ' + mar +' - 100% )'}, 250);
//                        }
//                        else{
//                            $(this).parent().parent().children(0).animate({'margin-left': '100%'}, 250);
//                        }
                    });
                }
                else{
                    console.log('no');
                    $('div.results').css('display', 'none');

                }


            }
        });
    });
    function calcPrice() {
        let tickets_to_price = parseFloat($('div#tickets_to_price').attr('data-price'));
        let tickets_from_price = parseFloat($('div#tickets_from_price').attr('data-price'));
        let hostel_price = parseFloat($('div#hostel_price').attr('data-price') * days);
        let attrs_price = 0;
        if($('form#attrForm input:checked').length > 0) {
            attrs_price = $('form#attrForm input:checked').map(function (e) {
                return parseFloat($(this).attr('data-price'));
            });
            attrs_price = Array.from(attrs_price).reduce(function (previousValue, currentValue, index, array) {
                return previousValue + currentValue;
            });
        }
//        alert(tickets_from_price);
//        alert(hostel_price);
//        alert(attrs_price);
        return tickets_to_price + tickets_from_price + hostel_price + attrs_price;
    }

})
</script>
</body>
</html>



